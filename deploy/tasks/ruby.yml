# ruby.yml --- Ruby
# author: Seong Yong-ju <sei40kr@gmail.com>
---
- name: Include variables
  include_vars:
    file: ../vars/ruby.yml
    name: ruby
- name: Check if rbenv exists
  stat:
    path: '{{ ruby.rbenv_root }}'
  register: rbenv_check
- name: Install rbenv
  git:
    dest: '{{ ruby.rbenv_root }}'
    repo: '{{ ruby.rbenv_repo }}'
  when: not rbenv_check.stat.exists
- name: Check if rbenv-build exists
  stat:
    path: '{{ ruby.rbenv_build_path }}'
  register: rbenv_build_check
- name: Install ruby-build
  git:
    dest: '{{ ruby.rbenv_build_path }}'
    repo: '{{ ruby.rbenv_build_repo }}'
  when: not rbenv_build_check.stat.exists
- name: Install Ruby
  shell: '{{ ruby.rbenv_root }}/bin/rbenv install -s {{ item }}'
  with_items: '{{ ruby.ruby_versions }}'
- name: Install Rubygems
  gem:
    executable: '{{ ruby.rbenv_root }}/versions/{{ item[0] }}/bin/gem'
    name: '{{ item[1] }}'
  with_nested:
    - '{{ ruby.ruby_versions }}'
    - '{{ ruby.rubygems }}'
- name: Set the installed version of Ruby as default
  shell: '{{ ruby.rbenv_root }}/bin/rbenv global {{ ruby.ruby_default_version }} && {{ ruby.rbenv_root }}/bin/rbenv rehash'
