#!/usr/bin/env bash

# install --- Installer for dotfiles
# author: Seong Yong-ju <sei40kr@gmail.com>

BASEDIR="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"

modules=(
    compton
    fcitx
    fontconfig
    ghq
    psd
    redshift
    ripgrep
    stalonetray
)

facades=(
    pacman
    trizen
    symlink
    systemctl
)


. "${BASEDIR}/install-scripts/utility.bash"

for arg in "$@"; do
    case "$arg" in
        -u|--upgrade )
            upgrade=1
            ;;
        -v|--verbose )
            verbose=1
            ;;
        --dry-run )
            dry_run=1
            ;;
    esac
done

do_upgrade() {
    [[ "$upgrade" == 1 ]]
}

is_verbose() {
    [[ "$verbose" == 1 ]]
}

do_dry_run() {
    [[ "$dry_run" == 1 ]]
}

facade_reducers=()

facade_add_reducer() {
    facade_reducers=( "${facade_reducers[@]}" "$1" )
}

. "${BASEDIR}/install-scripts/facade-utility.bash"

for facade in "${facades[@]}"; do
    . "${BASEDIR}/install-scripts/facades/${facade}.bash"
done

. "${BASEDIR}/install-scripts/utility.bash"

is_arch=0
is_arch && is_arch=1

for module in "${modules[@]}"; do
    ctxpath="${BASEDIR}/install-scripts/modules/${module}"
    srcpaths=()

    [[ "$is_arch" == 1 ]] && srcpaths=( "${srcpaths[@]}" "${ctxpath}/arch.bash" )
    is_macos && srcpaths=( "${srcpaths[@]}" "${ctxpath}/macos.bash" )
    is_linux && srcpaths=( "${srcpaths[@]}" "${ctxpath}/linux.bash" )
    srcpaths=( "${srcpaths[@]}" "${ctxpath}/default.bash" )

    for srcpath in "${srcpaths[@]}"; do
        if [[ -s "$srcpath" ]]; then
            . "$srcpath"
        fi
    done
done


for reducer in "${facade_reducers[@]}"; do
    eval "$reducer"
done
