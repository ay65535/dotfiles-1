#!/usr/bin/env bash

# install --- Installer for dotfiles
# author: Seong Yong-ju <sei40kr@gmail.com>

DOTFILES_PATH="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"

: ${XDG_CONFIG_HOME:=${HOME}/.config}
: ${XDG_DATA_HOME:=${HOME}/.local/share}


. "${DOTFILES_PATH}/install-scripts/utility.bash"

## Parse arguments

is_dry_run=0
do_update=0
is_verbose=0

declare -a modules_to_install
modules_to_install=()

for arg in "$@"; do
    case "$arg" in
        --dry-run )
            is_dry_run=1
            ;;
        --update|-u )
            do_update=1
            ;;
        --verbose|-v )
            is_verbose=1
            ;;
        * )
            modules_to_install+=( "$arg" )
    esac
done

if [[ "${#modules_to_install[@]}" == 0 ]]; then
    for module in "${DOTFILES_PATH}/install-scripts/modules"/*.bash; do
        modules_to_install+=( "$(basename -s .bash "${module}")" )
    done
fi


## Load facades

for facade_path in "${DOTFILES_PATH}/install-scripts/facades"/*.bash; do
    . "${facade_path}"
done


## Load modules

for module in "${modules_to_install[@]}"; do
    module_path="${DOTFILES_PATH}/install-scripts/modules/${module}.bash"

    if [[ ! -s "$module_path" ]]; then
        die "${module} module is not found." >&2
        exit 1
    fi

    . "$module_path"
done


## Run reducers

run_all_facade_reducers
