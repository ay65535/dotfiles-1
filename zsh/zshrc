# -*- mode: sh -*-

# zshrc
# author: Seong Yong-ju <sei40kr@gmail.com>

if [[ -z "$TMUX" && -z "$INSIDE_EMACS" && -z "$EMACS" && -z "$VIM" && "$TERM" != dumb ]]; then
    export LC_ALL
    tmux new-session
    exit
fi

__main() {
    autoload -Uz \
             gh-create \
             kca \
             kres \
             pyclean \
             ranger-cd

    if [[ "${+commands[vimpager]}" == 1 ]]; then
        export PAGER=vimpager
        export MANPAGER=vimpager
    fi

    HISTFILE="${ZDOTDIR}/.zsh_history"
    HISTSIZE=10000
    SAVEHIST=10000

    setopt APPEND_HISTORY
    setopt AUTO_CD
    setopt AUTO_LIST
    setopt AUTO_MENU
    setopt AUTO_PUSHD
    setopt AUTO_PARAM_KEYS
    setopt AUTO_PARAM_SLASH
    setopt AUTO_RESUME
    setopt EQUALS
    setopt EXTENDED_HISTORY
    setopt GLOB_DOTS
    setopt HIST_IGNORE_ALL_DUPS
    setopt HIST_IGNORE_SPACE
    setopt HIST_REDUCE_BLANKS
    setopt INC_APPEND_HISTORY
    setopt INTERACTIVE_COMMENTS
    setopt NO_BEEP
    setopt NUMERIC_GLOB_SORT
    setopt PRINT_EIGHT_BIT
    setopt PROMPT_SUBST
    setopt PUSHD_IGNORE_DUPS
    setopt SHARE_HISTORY
    unsetopt LIST_BEEP

    bindkey -e

    is_macos() {
        [[ "$OSTYPE" == darwin* ]]
    }

    is_arch() {
        [[ -f /etc/arch-release ]]
    }


    . "${HOME}/.zplugin/bin/zplugin.zsh"

    HYPHEN_INSENSITIVE=true
    zplugin ice svn multisrc'{completion,termsupport,clipboard}.zsh'
    zplugin snippet OMZ::lib

    zplugin snippet OMZ::plugins/zsh_reload/zsh_reload.plugin.zsh

    zplugin ice pick'' blockf wait''
    zplugin light zsh-users/zsh-completions

    zplugin snippet OMZ::plugins/extract/extract.plugin.zsh
    zplugin snippet OMZ::plugins/rsync/rsync.plugin.zsh
    zplugin snippet OMZ::plugins/nmap/nmap.plugin.zsh

    GH_CLONE_WORKSPACE_DIR="${HOME}/develop/workspace"
    zplugin light _local/zsh-gh-clone


    ## OS-specific Plugins

    if is_arch; then
        zplugin snippet OMZ::plugins/archlinux/archlinux.plugin.zsh
    fi


    ## Git

    zplugin snippet 'OMZ::plugins/git/git.plugin.zsh'
    zplugin snippet 'OMZ::plugins/git-flow/git-flow.plugin.zsh'


    ## Rust

    zplugin ice as'completion' wait''
    zplugin snippet OMZ::plugins/rust/_rust
    zplugin ice as'completion' wait''
    zplugin snippet OMZ::plugins/cargo/_cargo


    ## Go

    if [[ -n "$GOENV_ROOT" && -d "$GOENV_ROOT" ]]; then
        if [[ ! -f "${GOENV_ROOT}/zgoenv.zsh" ]]; then
            goenv init - --no-rehash zsh >"${GOENV_ROOT}/zgoenv.zsh"
        fi

        zplugin snippet "${GOENV_ROOT}/zgoenv.zsh"
    fi

    zplugin snippet OMZ::plugins/golang/golang.plugin.zsh


    ## Haskell

    zplugin ice wait''
    zplugin snippet 'OMZ::plugins/stack/stack.plugin.zsh'
    zplugin ice wait''
    zplugin snippet 'OMZ::plugins/cabal/cabal.plugin.zsh'


    ## Java

    zplugin snippet OMZ::plugins/mvn/mvn.plugin.zsh
    zplugin snippet OMZ::plugins/gradle/gradle.plugin.zsh


    ## Scala

    zplugin ice as'completion' wait''
    zplugin snippet OMZ::plugins/scala/_scala
    zplugin ice svn
    zplugin snippet OMZ::plugins/sbt


    ## Perl

    if [[ -n "$PERLBREW_ROOT" && -d "$PERLBREW_ROOT" ]]; then
        zplugin ice wait''
        zplugin snippet "${PERLBREW_ROOT}/etc/perlbrew-completion.bash"
    fi

    zplugin snippet OMZ::plugins/perl/perl.plugin.zsh
    zplugin ice as'completion' wait''
    zplugin snippet OMZ::plugins/cpanm/_cpanm


    ## Python

    if [[ -n "$PYENV_ROOT" && -d "$PYENV_ROOT" ]]; then
        if [[ ! -f "${PYENV_ROOT}/zpyenv.zsh" ]]; then
            { pyenv init - --no-rehash zsh
              pyenv virtualenv-init - zsh
            } >"${PYENV_ROOT}/zpyenv.zsh"
        fi

        zplugin snippet "${PYENV_ROOT}/zpyenv.zsh"
    fi

    zplugin ice as'completion' wait''
    zplugin snippet OMZ::plugins/pip/_pip


    ## Ruby

    if [[ -n "$RBENV_ROOT" && -d "$RBENV_ROOT" ]]; then
        if [[ ! -f "${RBENV_ROOT}/zrbenv.zsh" ]]; then
            rbenv init - --no-rehash zsh >"${RBENV_ROOT}/zrbenv.zsh"
        fi

        zplugin snippet "${RBENV_ROOT}/zrbenv.zsh"
    fi

    zplugin snippet OMZ::plugins/ruby/ruby.plugin.zsh
    zplugin ice svn
    zplugin snippet OMZ::plugins/gem
    zplugin ice wait''
    zplugin snippet OMZ::plugins/rake-fast/rake-fast.plugin.zsh

    # Rails
    zplugin ice svn
    zplugin snippet OMZ::plugins/rails


    ## PHP

    zplugin snippet OMZ::plugins/composer/composer.plugin.zsh
    zplugin snippet OMZ::plugins/laravel/laravel.plugin.zsh
    zplugin snippet OMZ::plugins/laravel5/laravel5.plugin.zsh


    ## Web Frontend

    export NVM_AUTO_USE=true
    zplugin light lukechilds/zsh-nvm

    zplugin ice wait''
    zplugin light lukechilds/zsh-better-npm-completion
    zplugin snippet OMZ::plugins/yarn/yarn.plugin.zsh

    # Gatsby
    zplugin ice as'completion' wait''
    zplugin snippet OMZ::plugins/gatsby/_gatsby

    # React Native
    zplugin ice svn
    zplugin snippet OMZ::plugins/react-native

    # Flutter
    zplugin ice svn
    zplugin snippet OMZ::plugins/flutter


    ## Database

    # Redis
    zplugin ice as'completion' wait''
    zplugin snippet OMZ::plugins/redis-cli/_redis-cli


    ## Continuous Integration

    # Docker
    zplugin snippet OMZ::plugins/docker-compose/docker-compose.plugin.zsh
    if is_macos && [[ -d '/Applications/Docker.app' ]]; then
        zplugin ice as'completion' wait'' multisrc'{docker,docker-compose}.zsh-completion'
        zplugin light '/Applications/Docker.app/Contents/Resources/etc'
    fi

    # Code Climate
    zplugin ice as'completion' wait''
    zplugin snippet OMZ::plugins/codeclimate/_codeclimate

    # Travis CI Client
    if [[ -f "${HOME}/.travis/travis.sh" ]]; then
        zplugin ice wait''
        zplugin snippet "${HOME}/.travis/travis.sh"
    fi


    ## Infrastructure

    zplugin ice as'completion' wait''
    zplugin snippet OMZ::plugins/vagrant/_vagrant
    zplugin snippet OMZ::plugins/ansible/ansible.plugin.zsh
    zplugin snippet OMZ::plugins/kubectl/kubectl.plugin.zsh

    # gcloud
    if [[ -n "$CLOUDSDK_ROOT_DIR" && -d "$CLOUDSDK_ROOT_DIR" ]]; then
        zplugin ice wait''
        zplugin snippet "${CLOUDSDK_ROOT_DIR}/completion.zsh.inc"
    fi


    ## Others

    zplugin ice wait'0' atinit'zpcompinit; zpcdreplay' lucid
    zplugin light zdharma/fast-syntax-highlighting

    zplugin ice wait'0' lucid
    zplugin light -b zsh-users/zsh-autosuggestions

    zplugin ice wait'0' lucid
    zplugin light -b zdharma/history-search-multi-word

    zplugin light _local/zsh-run-help-collections

    zplugin snippet OMZ::plugins/fancy-ctrl-z/fancy-ctrl-z.plugin.zsh
    zplugin snippet OMZ::plugins/magic-enter/magic-enter.plugin.zsh

    zplugin ice from'gh-r' as'program' mv'direnv* -> direnv' atinit'[[ -f zhook.zsh ]] || ./direnv hook zsh >zhook.zsh' src'zhook.zsh'
    zplugin light direnv/direnv

    # FZF
    FZF_DEFAULT_OPTS='--height=15 --reverse --inline-info --color=dark --color=fg:-1,bg:-1,hl:#c678dd,fg+:#ffffff,bg+:#4b5263,hl+:#d858fe --color=info:#98c379,prompt:#61afef,pointer:#be5046,marker:#e5c07b,spinner:#61afef,header:#61afef'
    zplugin ice bindmap'^R ->' multisrc'shell/{completion,key-bindings}.zsh'
    zplugin light -b junegunn/fzf

    # FZF additional sources
    zplugin light _local/zsh-fzf-docker
    zplugin light _local/zsh-fzf-cd-dirs
    if [[ -z "$TMUX" ]]; then
        FZF_PROJECTS_WORKSPACE_DIRS=(
            "${HOME}/develop/workspace"
            "${GOPATH}/src/github.com"
        )
        FZF_PROJECTS_PROJECT_DIR_MAX_DEPTH=2
        FZF_PROJECTS_KNOWN_PROJECTS=(
            "${HOME}/.dotfiles"
            "${HOME}/.emacs.d"
            "${HOME}/.spacemacs.d"
        )
        zplugin light _local/zsh-fzf-projects

        zle -N fzf-projects

        bindkey '^xg' fzf-projects
        bindkey '^x^g' fzf-projects
    fi

    # Notification
    if is_macos; then
        zplugin ice from'gh-r' as'program'
        zplugin light julienXX/terminal-notifier
    fi
    zplugin snippet OMZ::plugins/bgnotify/bgnotify.plugin.zsh

    # Other alias definitions
    . "${ZDOTDIR}/alias_defs.zsh"

    ## Theme & Appearance

    zplugin ice from'gh-r' src'zstarship.zsh' atclone'./starship init zsh --print-full-init >zstarship.zsh' atpull'%atclone' atload'starship_precmd' as'program' nocompile'!'
    zplugin light starship/starship

    local fast_alias_tips_dir="${GOPATH}/src/github.com/sei40kr/zsh-fast-alias-tips"
    path=( "$fast_alias_tips_dir" "${path[@]}" )
    export PATH
    . "${fast_alias_tips_dir}/fast-alias-tips.plugin.zsh"
}

if [[ "$TERM" == dumb ]]; then
    HISTSIZE=0
    SAVEHIST=0
else
    __main
fi
