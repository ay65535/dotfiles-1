# -*- mode: sh -*-

# zshrc
# author: Seong Yong-ju <sei40kr@gmail.com>

if [[ -z "$TMUX" && -z "$INSIDE_EMACS" && -z "$EMACS" && -z "$VIM" ]]; then
    __socket_name="${SSH_CLIENT:+$(awk '{ gsub(/\./, "_", $1); print $1 }' <<<"$SSH_CLIENT")}"
    tmux -L "${__socket_name:-default}" attach-session ||
        tmux -L "${__socket_name:-default}" new-session
    exit
fi

autoload -Uz \
         clone_gh \
         create_gh \
         dcin \
         dii \
         dirm \
         dni \
         drm \
         drmf \
         dst \
         dstp \
         dvi \
         dxb \
         fzf-remote-widget \
         fzf-project-widget \
         kca \
         kres \
         magit \
         pyclean \
         ranger-cd

. "${ZDOTDIR}/func_defs.zsh"
. "${ZDOTDIR}/func_defs_emacs.zsh"
. "${ZDOTDIR}/alias_defs.zsh"

setopt APPEND_HISTORY
setopt AUTO_CD
setopt AUTO_LIST
setopt AUTO_MENU
setopt AUTO_PUSHD
setopt AUTO_PARAM_KEYS
setopt AUTO_PARAM_SLASH
setopt AUTO_RESUME
setopt EQUALS
setopt EXTENDED_HISTORY
setopt GLOB_DOTS
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_IGNORE_SPACE
setopt HIST_REDUCE_BLANKS
setopt INC_APPEND_HISTORY
setopt INTERACTIVE_COMMENTS
setopt NO_BEEP
setopt NUMERIC_GLOB_SORT
setopt PRINT_EIGHT_BIT
setopt PROMPT_SUBST
setopt PUSHD_IGNORE_DUPS
setopt SHARE_HISTORY
unsetopt LIST_BEEP

zle -N fzf-remote-widget
zle -N fzf-project-widget

bindkey -e
bindkey '^xr' fzf-remote-widget
bindkey '^x^r' fzf-remote-widget
bindkey '^xg' fzf-project-widget
bindkey '^x^g' fzf-project-widget

autoload -Uz bashcompinit && bashcompinit

[[ -d "${GOENV_ROOT:-${HOME}/.goenv}" ]] && eval "$(goenv init - --no-rehash zsh)"
[[ -d "${PYENV_ROOT:-${HOME}/.pyenv}" ]] && eval "$(pyenv init - --no-rehash zsh)"
[[ -d "${RBENV_ROOT:-${HOME}/.rbenv}" ]] && eval "$(rbenv init - --no-rehash zsh)"
[[ -d "${SDKMAN_DIR:-${HOME}/.sdkman}" ]] && . "${SDKMAN_DIR}/bin/sdkman-init.sh"
[[ "${+commands[direnv]}" == 1 ]] && eval "$(direnv hook zsh)"

. "${HOME}/.zplugin/bin/zplugin.zsh"


# commands
#
zplugin snippet 'OMZ::lib/clipboard.zsh'
zplugin ice svn
zplugin snippet 'OMZ::plugins/extract'
zplugin snippet 'OMZ::plugins/perl/perl.plugin.zsh'
zplugin snippet 'OMZ::plugins/zsh_reload/zsh_reload.plugin.zsh'

FZF_DEFAULT_OPTS='--height=15 --reverse --inline-info --color=dark --color=fg:-1,bg:-1,hl:#c678dd,fg+:#ffffff,bg+:#4b5263,hl+:#d858fe --color=info:#98c379,prompt:#61afef,pointer:#be5046,marker:#e5c07b,spinner:#61afef,header:#61afef'
zplugin ice multisrc'shell/{completion,key-bindings}.zsh'
zplugin light junegunn/fzf
bindkey -r '^R'


# command aliases and completions
#
zplugin ice svn
zplugin snippet 'OMZ::plugins/ansible'
zplugin ice svn
zplugin snippet 'OMZ::plugins/cabal'
zplugin ice svn pick'' wait''
zplugin snippet 'OMZ::plugins/cargo'
zplugin ice svn pick'' wait''
zplugin snippet 'OMZ::plugins/codeclimate'
zplugin ice svn
zplugin snippet 'OMZ::plugins/composer'
zplugin ice svn pick'' wait''
zplugin snippet 'OMZ::plugins/cpanm'
zplugin ice svn pick'docker-compose.plugin.zsh' nocompletions
zplugin snippet 'OMZ::plugins/docker-compose'
zplugin ice svn
zplugin snippet 'OMZ::plugins/gem'
zplugin snippet 'OMZ::plugins/git/git.plugin.zsh'
zplugin ice svn pick'git-completion.bash' silent
zplugin snippet 'OMZ::plugins/gitfast'
zplugin ice svn
zplugin snippet 'OMZ::plugins/git-flow'
zplugin ice svn
zplugin snippet 'OMZ::plugins/golang'
zplugin ice svn
zplugin snippet 'OMZ::plugins/gradle'
# zplugin ice svn
# zplugin snippet 'OMZ::plugins/kubectl'
zplugin ice svn
zplugin snippet 'OMZ::plugins/laravel'
zplugin ice svn
zplugin snippet 'OMZ::plugins/laravel5'
# zplugin ice svn
# zplugin snippet 'OMZ::plugins/minikube'
zplugin ice svn
zplugin snippet 'OMZ::plugins/mvn'
zplugin snippet 'OMZ::plugins/nmap/nmap.plugin.zsh'
# zplugin snippet 'OMZ::plugins/npm/npm.plugin.zsh'
zplugin ice svn
zplugin snippet 'OMZ::plugins/pip'
zplugin ice svn
zplugin snippet 'OMZ::plugins/rails'
zplugin ice svn
zplugin snippet 'OMZ::plugins/rake-fast'
zplugin ice svn
zplugin snippet 'OMZ::plugins/react-native'
zplugin ice svn pick'' wait''
zplugin snippet 'OMZ::plugins/redis-cli'
zplugin ice svn
zplugin snippet 'OMZ::plugins/rsync'
zplugin ice svn pick'' wait''
zplugin snippet 'OMZ::plugins/rust'
zplugin ice svn
zplugin snippet 'OMZ::plugins/sbt'
zplugin ice svn pick'' wait''
zplugin snippet 'OMZ::plugins/scala'
zplugin ice svn
zplugin snippet 'OMZ::plugins/stack'
zplugin ice svn pick'' wait''
zplugin snippet 'OMZ::plugins/vagrant'
zplugin ice svn
zplugin snippet 'OMZ::plugins/yarn'

zplugin ice wait''
zplugin light lukechilds/zsh-better-npm-completion
zplugin ice pick'' blockf wait''
zplugin light zsh-users/zsh-completions

# docker
if [[ "$OSTYPE" == darwin* ]]; then
    __docker_etc='/Applications/Docker.app/Contents/Resources/etc'
    zplugin ice wait''
    zplugin snippet "${__docker_etc}/docker.zsh-completion"
    zplugin ice wait''
    zplugin snippet "${__docker_etc}/docker-compose.zsh-completion"
else
    zplugin ice svn pick'' wait''
    zplugin snippet 'OMZ::plugins/docker'
    zplugin ice svn pick'' wait''
    zplugin snippet 'OMZ::plugins/docker-compose'
fi

# gcloud
if [[ -n "$__gcloud_sdk" ]]; then
    zplugin ice wait''
    zplugin snippet "${__gcloud_sdk}/completion.zsh.inc"
fi

# perlbrew
if [[ -d "${PERLBREW_ROOT:-${HOME}/perl5/perlbrew}" ]]; then
    zplugin ice wait''
    zplugin snippet "${PERLBREW_ROOT}/etc/perlbrew-completion.bash"
fi

# travis
if [[ -f "${HOME}/.travis/travis.sh" ]]; then
    zplugin ice wait''
    zplugin snippet "${HOME}/.travis/travis.sh"
fi


# version managers
#
export NVM_SYMLINK_CURRENT=true
export NVM_LAZY_LOAD=true
export NVM_AUTO_USE=true
zplugin light lukechilds/zsh-nvm


# tools and configurations
#
zplugin snippet 'OMZ::lib/completion.zsh'
zplugin snippet 'OMZ::lib/compfix.zsh'
zplugin snippet 'OMZ::plugins/bgnotify/bgnotify.plugin.zsh'
zplugin snippet 'OMZ::plugins/colored-man-pages/colored-man-pages.plugin.zsh'
zplugin snippet 'OMZ::plugins/fancy-ctrl-z/fancy-ctrl-z.plugin.zsh'

zplugin ice make
zplugin light _local/zsh-fast-alias-tips
zplugin ice wait'1' lucid atload'zpcompinit && __cdreplay'
zplugin light zdharma/fast-syntax-highlighting
zplugin ice wait'1' lucid
zplugin light zdharma/history-search-multi-word
zplugin ice wait'1' lucid
zplugin light zsh-users/zsh-autosuggestions


# prompt
#
zplugin ice wait'!0'
zplugin light denysdovhan/spaceship-prompt

__cdreplay() {
    zpcdreplay &&
        compdef _rails _rails_command &&
        compdef _rake _rake_command
}
